{% extends "forum/base.html" %}

{% block title %}{{ topic.title }} - GXC Forum{% endblock %}

{% block content %}
<!-- Topic Header -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                    <a href="/forum/category/{{ topic.category_slug }}" class="badge bg-primary me-2">
                        {{ topic.category_name }}
                    </a>
                    {% if topic.is_pinned %}
                    <span class="badge bg-warning me-2"><i class="fas fa-thumbtack"></i> Pinned</span>
                    {% endif %}
                    {% if topic.is_locked %}
                    <span class="badge bg-danger"><i class="fas fa-lock"></i> Locked</span>
                    {% endif %}
                </div>
                <h2 class="mb-2">{{ topic.title }}</h2>
                <div class="d-flex align-items-center text-muted">
                    <div class="avatar me-2">
                        {{ topic.username[0].upper() }}
                    </div>
                    <span>{{ topic.username }}</span>
                    <span class="mx-2">•</span>
                    <span>{{ topic.created_at[:16] }}</span>
                    <span class="mx-2">•</span>
                    <span><i class="fas fa-eye me-1"></i>{{ topic.view_count }} views</span>
                </div>
            </div>
            {% if session and session.user_id and (session.user_id == topic.author_id or session.is_admin or session.is_moderator) %}
            <div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteTopic({{ topic.topic_id }})" title="Delete Topic">
                    <i class="fas fa-trash"></i> Delete Topic
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Posts -->
{% for post in posts %}
<div class="card mb-3" id="post-{{ post.post_id }}">
    <div class="card-body">
        <div class="row">
            <div class="col-md-2 text-center">
                <div class="avatar mx-auto mb-2" style="width: 60px; height: 60px; font-size: 1.5rem;">
                    {{ post.username[0].upper() }}
                </div>
                <h6 class="mb-1">{{ post.username }}</h6>
                {% if post.reputation > 0 %}
                <span class="badge badge-reputation">
                    <i class="fas fa-star me-1"></i>{{ post.reputation }}
                </span>
                {% endif %}
                <div class="mt-2">
                    <small class="text-muted d-block">Posts: {{ post.posts_count or 0 }}</small>
                </div>
            </div>
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <small class="text-muted">#{{ loop.index }} • {{ post.created_at[:16] }}</small>
                    {% if post.is_edited %}
                    <small class="text-muted"><i class="fas fa-edit"></i> Edited</small>
                    {% endif %}
                </div>
                <div class="post-content">
                    {% if post.content.startswith('<') or '```' in post.content or '**' in post.content or '#' in post.content[:10] %}
                        {{ post.content|safe }}
                    {% else %}
                        {{ post.content|replace('\n', '<br>')|safe }}
                    {% endif %}
                </div>
                {% if post.signature %}
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted italic">{{ post.signature }}</small>
                </div>
                {% endif %}
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm {% if post.user_reaction == 'upvote' %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                            onclick="upvote({{ post.post_id }})" id="upvote-{{ post.post_id }}">
                        <i class="fas fa-arrow-up"></i> <span id="upvote-count-{{ post.post_id }}">{{ post.upvotes or 0 }}</span>
                    </button>
                    <button class="btn btn-sm {% if post.user_reaction == 'downvote' %}btn-secondary{% else %}btn-outline-secondary{% endif %}" 
                            onclick="downvote({{ post.post_id }})" id="downvote-{{ post.post_id }}">
                        <i class="fas fa-arrow-down"></i> <span id="downvote-count-{{ post.post_id }}">{{ post.downvotes or 0 }}</span>
                    </button>
                    {% if session and session.user_id and not topic.is_locked %}
                    <button class="btn btn-sm btn-outline-info" onclick="quotePost({{ post.post_id }}, '{{ post.username }}')">
                        <i class="fas fa-quote-left"></i> Quote
                    </button>
                    {% endif %}
                    {% if session and session.user_id and (session.user_id == post.author_id or session.is_admin or session.is_moderator) %}
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePost({{ post.post_id }}, {{ post.topic_id }})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Reply Form -->
                    {% if session and session.user_id and not topic.is_locked %}
<div class="card">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-reply me-2"></i>Post a Reply</h5>
    </div>
            <div class="card-body">
                <form method="POST" action="/forum/topic/{{ topic.topic_id }}/reply">
                    <div class="mb-3">
                        <div class="btn-group mb-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setReplyMode('markdown')">
                                <i class="fab fa-markdown me-1"></i>Markdown
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setReplyMode('html')">
                                <i class="fab fa-html5 me-1"></i>HTML
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setReplyMode('plain')">
                                <i class="fas fa-text-height me-1"></i>Plain
                            </button>
                        </div>
                        <textarea class="form-control" name="content" id="replyContent" rows="6" placeholder="Write your reply here..." required></textarea>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="uploadReplyFile()">
                                <i class="fas fa-upload me-1"></i>Upload Image/File
                            </button>
                            <input type="file" id="replyFileUpload" style="display: none;" accept="image/*,.pdf,.txt,.md" onchange="handleReplyFileUpload(this)">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Post Reply
                    </button>
                </form>
            </div>
</div>
{% elif not session or not session.user_id %}
<div class="card">
    <div class="card-body text-center py-4">
        <p class="text-muted mb-3">Please <a href="/forum/login">login</a> to reply to this topic.</p>
        <a href="/forum/login" class="btn btn-primary">Login</a>
        <a href="/forum/register" class="btn btn-outline-primary">Register</a>
    </div>
</div>
{% endif %}

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
        </li>
        {% endfor %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let replyMode = 'markdown';

function upvote(postId) {
    {% if not session or not session.user_id %}
    alert('Please login to vote');
    return;
    {% endif %}
    
    const button = document.getElementById(`upvote-${postId}`);
    const downvoteBtn = document.getElementById(`downvote-${postId}`);
    const upvoteCount = document.getElementById(`upvote-count-${postId}`);
    const downvoteCount = document.getElementById(`downvote-count-${postId}`);
    
    button.disabled = true;
    
    fetch(`/forum/api/post/${postId}/reaction`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({type: 'upvote', action: 'toggle'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update counts
            if (upvoteCount) upvoteCount.textContent = data.upvotes;
            if (downvoteCount) downvoteCount.textContent = data.downvotes;
            
            // Update button styles
            if (data.action === 'added' || data.action === 'changed') {
                button.classList.add('btn-primary');
                button.classList.remove('btn-outline-primary');
                // Remove downvote if changed
                if (downvoteBtn && data.action === 'changed') {
                    downvoteBtn.classList.remove('btn-secondary');
                    downvoteBtn.classList.add('btn-outline-secondary');
                }
            } else {
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to vote'));
        }
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error voting. Please try again.');
        button.disabled = false;
    });
}

function downvote(postId) {
    {% if not session or not session.user_id %}
    alert('Please login to vote');
    return;
    {% endif %}
    
    const button = document.getElementById(`downvote-${postId}`);
    const upvoteBtn = document.getElementById(`upvote-${postId}`);
    const upvoteCount = document.getElementById(`upvote-count-${postId}`);
    const downvoteCount = document.getElementById(`downvote-count-${postId}`);
    
    button.disabled = true;
    
    fetch(`/forum/api/post/${postId}/reaction`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({type: 'downvote', action: 'toggle'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update counts
            if (upvoteCount) upvoteCount.textContent = data.upvotes;
            if (downvoteCount) downvoteCount.textContent = data.downvotes;
            
            // Update button styles
            if (data.action === 'added' || data.action === 'changed') {
                button.classList.add('btn-secondary');
                button.classList.remove('btn-outline-secondary');
                // Remove upvote if changed
                if (upvoteBtn && data.action === 'changed') {
                    upvoteBtn.classList.remove('btn-primary');
                    upvoteBtn.classList.add('btn-outline-primary');
                }
            } else {
                button.classList.remove('btn-secondary');
                button.classList.add('btn-outline-secondary');
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to vote'));
        }
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error voting. Please try again.');
        button.disabled = false;
    });
}

function setReplyMode(mode) {
    replyMode = mode;
    const textarea = document.getElementById('replyContent');
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'markdown') {
        textarea.placeholder = 'Write in Markdown format...';
    } else if (mode === 'html') {
        textarea.placeholder = 'Write in HTML format...';
    } else {
        textarea.placeholder = 'Write your reply here...';
    }
}

function uploadReplyFile() {
    document.getElementById('replyFileUpload').click();
}

function handleReplyFileUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/forum/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                const textarea = document.getElementById('replyContent');
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(cursorPos);
                
                let insertText = '';
                if (file.type.startsWith('image/')) {
                    if (replyMode === 'markdown') {
                        insertText = `![${file.name}](${data.url})`;
                    } else if (replyMode === 'html') {
                        insertText = `<img src="${data.url}" alt="${file.name}">`;
                    } else {
                        insertText = data.url;
                    }
                } else {
                    insertText = `[${file.name}](${data.url})`;
                }
                
                textarea.value = textBefore + insertText + textAfter;
                textarea.focus();
                textarea.setSelectionRange(cursorPos + insertText.length, cursorPos + insertText.length);
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed');
        });
    }
}

function quotePost(postId, username) {
    const textarea = document.getElementById('replyContent');
    if (textarea) {
        if (replyMode === 'markdown') {
            textarea.value = `> Quote from ${username}:\n\n\n`;
        } else if (replyMode === 'html') {
            textarea.value = `<blockquote><p>Quote from ${username}:</p></blockquote>\n\n`;
        } else {
            textarea.value = `[Quote from ${username}]\n\n`;
        }
        textarea.focus();
        textarea.scrollIntoView({ behavior: 'smooth' });
    }
}

function deletePost(postId, topicId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/forum/post/${postId}/delete`;
    
    document.body.appendChild(form);
    form.submit();
}

function deleteTopic(topicId) {
    if (!confirm('Are you sure you want to delete this entire topic? This will delete all posts in this topic. This action cannot be undone.')) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/forum/topic/${topicId}/delete`;
    
    document.body.appendChild(form);
    form.submit();
}

// Render markdown in post content
document.addEventListener('DOMContentLoaded', function() {
    const postContents = document.querySelectorAll('.post-content');
    postContents.forEach(content => {
        const text = content.textContent;
        if (text.includes('**') || text.includes('#') || text.includes('```') || text.includes('[')) {
            // Likely markdown, render it
            if (typeof marked !== 'undefined') {
                content.innerHTML = marked.parse(text);
            }
        }
    });
});
</script>
{% endblock %}

