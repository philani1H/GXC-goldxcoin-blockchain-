{% extends "forum/base.html" %}

{% block title %}Live Chat Support - GXC Forum{% endblock %}

{% block extra_css %}
<style>
    .chat-wrapper {
        max-width: 1200px;
        margin: 0 auto;
    }

    .chat-container {
        height: 70vh;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .chat-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1.5rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .chat-header h4 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chat-header .status-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--light-bg);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    .message {
        display: flex;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
        max-width: 75%;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.user {
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message.user .message-avatar {
        background: var(--primary-gradient);
        color: white;
    }

    .message.ai .message-avatar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .message.admin .message-avatar {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .message-content {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .message-bubble {
        padding: 1rem 1.25rem;
        border-radius: 16px;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message.user .message-bubble {
        background: var(--primary-gradient);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.ai .message-bubble {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
    }

    .message.admin .message-bubble {
        background: #eff6ff;
        border: 1px solid #3b82f6;
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
    }

    [data-theme="dark"] .message.ai .message-bubble {
        background: var(--card-bg);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .message.admin .message-bubble {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    .message-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .message.user .message-header {
        justify-content: flex-end;
    }

    .message-text {
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
    }

    .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        max-width: 120px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .typing-indicator.active {
        display: flex;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary-color);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    .chat-input-container {
        padding: 1.5rem;
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .chat-input-wrapper {
        flex: 1;
        position: relative;
    }

    .chat-input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-size: 0.95rem;
        background: var(--light-bg);
        color: var(--text-primary);
        transition: all 0.2s;
        resize: none;
        min-height: 52px;
        max-height: 120px;
        font-family: inherit;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    .send-button:active:not(:disabled) {
        transform: scale(0.95);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .welcome-message {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-secondary);
    }

    .welcome-message i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .welcome-message h5 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .quick-action-btn {
        padding: 0.5rem 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 0.85rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-action-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 200px);
            border-radius: 12px;
        }

        .message {
            max-width: 85%;
        }

        .chat-input-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <div class="card border-0">
        <div class="chat-container">
            <div class="chat-header">
                <h4>
                    <i class="fas fa-robot"></i>
                    Live Chat Support
                    <span class="status-badge ms-auto">
                        <span class="status-indicator"></span>
                        Online
                    </span>
                </h4>
                <small style="opacity: 0.9;">Powered by Bytez AI (Qwen2.5-0.5B) â€¢ Instant responses</small>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                {% if not chat_history or chat_history|length == 0 %}
                <div class="welcome-message">
                    <i class="fas fa-comments"></i>
                    <h5>Welcome to GXC Support!</h5>
                    <p>Ask me anything about GXC blockchain, mining, trading, or development.</p>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="quickQuestion('How do I start mining GXC?')">
                            <i class="fas fa-pickaxe me-1"></i>Mining Guide
                        </button>
                        <button class="quick-action-btn" onclick="quickQuestion('What are GXC-G gold-backed tokens?')">
                            <i class="fas fa-coins me-1"></i>Gold Tokens
                        </button>
                        <button class="quick-action-btn" onclick="quickQuestion('How do I create a wallet?')">
                            <i class="fas fa-wallet me-1"></i>Wallet Setup
                        </button>
                        <button class="quick-action-btn" onclick="quickQuestion('Tell me about stock contracts')">
                            <i class="fas fa-chart-line me-1"></i>Stock Contracts
                        </button>
                    </div>
                </div>
                {% else %}
                    {% for chat in chat_history %}
                    <div class="message {% if chat.response_type == 'admin' %}admin{% elif chat.response_type == 'ai' %}ai{% else %}user{% endif %}">
                        <div class="message-avatar">
                            {% if chat.response_type == 'admin' %}
                                <i class="fas fa-shield-alt"></i>
                            {% elif chat.response_type == 'ai' %}
                                <i class="fas fa-robot"></i>
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                {% if chat.response_type == 'admin' %}
                                    Admin: {{ chat.responder_username }}
                                {% elif chat.response_type == 'ai' %}
                                    AI Assistant
                                {% else %}
                                    You
                                {% endif %}
                                <span class="message-time">{{ chat.created_at[:16] }}</span>
                            </div>
                            <div class="message-bubble">
                                <div class="message-text">{{ chat.message }}</div>
                                {% if chat.response %}
                                <div class="message-text mt-2" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 0.75rem;">
                                    {{ chat.response }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chatInput" 
                           placeholder="Type your message here..." 
                           rows="1"
                           autocomplete="off"></textarea>
                </div>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io();
let currentChatId = null;

// Bytez.js API Configuration
const BYTEZ_API_KEY = 'f88a052c9302783e4c336bc893735dea';
const BYTEZ_MODEL_ID = 'Qwen/Qwen2.5-0.5B-Instruct';
const BYTEZ_API_URL = `https://api.bytez.com/run/${BYTEZ_MODEL_ID}`;

document.addEventListener('DOMContentLoaded', function() {
    socket.emit('join_user_chat', {user_id: {{ session.user_id }}});
    
    const input = document.getElementById('chatInput');
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    scrollToBottom();
});

function scrollToBottom() {
    const messages = document.getElementById('chatMessages');
    setTimeout(() => {
        messages.scrollTop = messages.scrollHeight;
    }, 100);
}

function quickQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendMessage();
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.disabled = true;
    document.getElementById('sendButton').disabled = true;
    
    addMessage('user', message, 'You');
    
    input.value = '';
    input.style.height = 'auto';
    
    document.getElementById('typingIndicator').classList.add('active');
    scrollToBottom();
    
    fetch('/forum/api/chat/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({message: message})
    })
    .then(response => response.json())
    .then(data => {
        currentChatId = data.chat_id;
        
        Promise.all([
            fetch('/forum/api/posts?limit=50').then(r => r.json()),
            fetch('/forum/api/topics?limit=30').then(r => r.json())
        ])
        .then(([posts, topics]) => {
            let context = `You are an expert AI assistant for the GXC (GoldXCoin) blockchain forum. You have COMPLETE knowledge of everything about GXC blockchain.

=== GXC BLOCKCHAIN - COMPLETE TECHNICAL SPECIFICATIONS ===

CORE BLOCKCHAIN:
- Name: GXC (GoldXCoin)
- Max Supply: 31,000,000 GXC
- Block Time: ~150 seconds (2.5 minutes)
- Consensus: Hybrid PoW + PoS
- RPC Endpoint: http://localhost:8545
- Explorer: {{ explorer_url }}
- Forum: {{ forum_url }}/forum

MINING ALGORITHMS (3 Supported):
1. SHA-256 (ASIC Mining):
   - Bitcoin-compatible algorithm
   - Best for ASIC miners
   - Software: gxc-sha256-miner
   - Pool: stratum+tcp://pool.gxc.network:3333

2. Ethash (GPU Mining):
   - Ethereum-compatible algorithm
   - Best for NVIDIA/AMD GPUs
   - Software: gxc-ethash-miner
   - Requires CUDA (NVIDIA) or ROCm (AMD)
   - Pool: stratum+tcp://pool.gxc.network:3334

3. GXHash (CPU Mining):
   - Custom algorithm optimized for traceability
   - Best for CPU mining
   - Software: gxc-gxhash-miner
   - Universal miner: gxc-miner (supports all)
   - Pool: stratum+tcp://pool.gxc.network:3335

MINING SETUP:
- Download from: http://localhost:3000/downloads
- Config file: ~/.gxc/mining.conf or config.json
- Required: miner address, pool URL, worker name
- Monitoring: gxc-miner --stats or pool dashboard

GOLD-BACKED TOKENS (GXC-G):
- Each GXC-G token backed by physical gold reserves
- Gold stored in secure vaults with regular audits
- Proof of Provenance (PoP) tracks gold origin
- Mint: Deposit gold to get GXC-G tokens
- Redeem: Exchange GXC-G for physical gold
- Reserve ratio maintained for full backing
- Attestation hashes verify authenticity

STOCK CONTRACT TOKENIZATION:
- Real-world stocks tokenized on blockchain
- Each contract represents company shares
- Price oracles provide real-time prices
- Supports: dividends, corporate actions, stock splits
- Full transparency of ownership
- Trading on blockchain

TRANSACTION SYSTEM:
- Full UTXO (Unspent Transaction Output) model
- Transaction inputs and outputs tracked
- Traceability system tracks transaction history
- Transaction types: transfer, coinbase, contract call
- Fields: hash, block, from, to, value, fee, gas, nonce, signature
- Special flags: is_coinbase, is_gold_backed, traceability_valid
- Memo field for notes
- Lock time support
- Fee burn mechanism
- PoP (Proof of Provenance) references

=== FORUM POSTS & DISCUSSIONS (Recent Activity) ===
`;
            
            if (posts && posts.length > 0) {
                posts.slice(0, 20).forEach((post, idx) => {
                    context += `\nPost ${idx + 1} (${post.category_name || 'General'} - ${post.topic_title || 'Topic'}):
Author: ${post.username || 'User'}
Content: ${post.content ? post.content.substring(0, 300) : 'No content'}${post.content && post.content.length > 300 ? '...' : ''}
Date: ${post.created_at || 'Unknown'}
`;
                });
            }
            
            if (topics && topics.length > 0) {
                context += `\n=== RECENT TOPICS ===\n`;
                topics.slice(0, 15).forEach((topic, idx) => {
                    context += `${idx + 1}. ${topic.title || 'Untitled'} (${topic.category_name || 'General'}) - ${topic.username || 'User'}\n`;
                });
            }
            
            // Prepare the prompt with context
            const fullPrompt = `${context}

USER QUESTION: ${message}

ASSISTANT: Provide a helpful, accurate response using the GXC blockchain knowledge above. Be conversational but informative.`;
            
            // Call Bytez API with Qwen model
            return fetch(BYTEZ_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': BYTEZ_API_KEY
                },
                body: JSON.stringify([{
                    role: "user",
                    content: fullPrompt
                }])
            });
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `API Error: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Bytez API Response:', data);
            
            // Extract response from Bytez API
            let aiResponse = '';
            
            // Try different possible response formats
            if (data.output) {
                // Direct output field
                aiResponse = data.output;
            } else if (data.result && data.result.output) {
                // Nested in result
                aiResponse = data.result.output;
            } else if (data.choices && data.choices[0] && data.choices[0].message) {
                // OpenAI-style format
                aiResponse = data.choices[0].message.content;
            } else if (data.response) {
                // Generic response field
                aiResponse = data.response;
            } else if (typeof data === 'string') {
                // Direct string response
                aiResponse = data;
            } else if (data.error) {
                throw new Error(data.error || 'API Error');
            } else {
                console.error('Unexpected response format:', data);
                throw new Error('Unexpected response format from AI');
            }
            
            if (!aiResponse || aiResponse.trim() === '') {
                throw new Error('Empty response from AI');
            }
            
            document.getElementById('typingIndicator').classList.remove('active');
            addMessage('ai', aiResponse, 'AI Assistant');
            
            fetch('/forum/api/chat/ai-response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: currentChatId,
                    response: aiResponse
                })
            });
            
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        })
        .catch(error => {
            console.error('AI Error:', error);
            document.getElementById('typingIndicator').classList.remove('active');
            addMessage('ai', 'Sorry, I encountered an error. Please try again or contact an admin.', 'AI Assistant');
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
        });
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('typingIndicator').classList.remove('active');
        addMessage('ai', 'Error sending message. Please try again.', 'System');
        input.disabled = false;
        document.getElementById('sendButton').disabled = false;
    });
}

function addMessage(type, text, sender) {
    const messages = document.getElementById('chatMessages');
    
    const welcome = messages.querySelector('.welcome-message');
    if (welcome) {
        welcome.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const now = new Date();
    const timestamp = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    
    let icon = 'fas fa-user';
    if (type === 'ai') icon = 'fas fa-robot';
    else if (type === 'admin') icon = 'fas fa-shield-alt';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${icon}"></i>
        </div>
        <div class="message-content">
            <div class="message-header">
                ${sender}
                <span class="message-time">${timestamp}</span>
            </div>
            <div class="message-bubble">
                <div class="message-text">${text.replace(/\n/g, '<br>')}</div>
            </div>
        </div>
    `;
    
    messages.appendChild(messageDiv);
    scrollToBottom();
}

socket.on('admin_response', function(data) {
    addMessage('admin', data.response, `Admin: ${data.responder}`);
});
</script>
{% endblock %}