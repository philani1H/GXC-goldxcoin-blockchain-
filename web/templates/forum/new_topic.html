{% extends "forum/base.html" %}

{% block title %}New Topic - GXC Forum{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-white">
                <h4 class="mb-0"><i class="fas fa-plus me-2"></i>Create New Topic</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="/forum/new-topic">
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Category</label>
                        <select class="form-select" name="category_id" id="category_id" required>
                            <option value="">Select a category...</option>
                            {% for category in categories %}
                            <option value="{{ category.category_id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label">Topic Title</label>
                        <input type="text" class="form-control" name="title" id="title" 
                               placeholder="Enter topic title..." required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <div class="btn-group mb-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setEditorMode('markdown')">
                                <i class="fab fa-markdown me-1"></i>Markdown
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setEditorMode('html')">
                                <i class="fab fa-html5 me-1"></i>HTML
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setEditorMode('plain')">
                                <i class="fas fa-text-height me-1"></i>Plain Text
                            </button>
                        </div>
                        <textarea class="form-control" name="content" id="content" rows="10" 
                                  placeholder="Write your post content here..." required></textarea>
                        <small class="text-muted">Supports Markdown, HTML, and plain text. Be respectful and follow community guidelines.</small>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="uploadFile()">
                                <i class="fas fa-upload me-1"></i>Upload Image/File
                            </button>
                            <input type="file" id="fileUpload" style="display: none;" accept="image/*,.pdf,.txt,.md" onchange="handleFileUpload(this)">
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Create Topic
                        </button>
                        <a href="/forum" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let editorMode = 'markdown';

function setEditorMode(mode) {
    editorMode = mode;
    const textarea = document.getElementById('content');
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'markdown') {
        textarea.placeholder = 'Write in Markdown format...\n\n# Heading\n**Bold** *Italic*\n[Link](url)\n![Image](url)';
    } else if (mode === 'html') {
        textarea.placeholder = 'Write in HTML format...\n\n<h1>Heading</h1>\n<p><strong>Bold</strong> <em>Italic</em></p>';
    } else {
        textarea.placeholder = 'Write your post content here...';
    }
}

function uploadFile() {
    document.getElementById('fileUpload').click();
}

function handleFileUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/forum/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                const textarea = document.getElementById('content');
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(cursorPos);
                
                let insertText = '';
                if (file.type.startsWith('image/')) {
                    if (editorMode === 'markdown') {
                        insertText = `![${file.name}](${data.url})`;
                    } else if (editorMode === 'html') {
                        insertText = `<img src="${data.url}" alt="${file.name}">`;
                    } else {
                        insertText = data.url;
                    }
                } else {
                    insertText = `[${file.name}](${data.url})`;
                }
                
                textarea.value = textBefore + insertText + textAfter;
                textarea.focus();
                textarea.setSelectionRange(cursorPos + insertText.length, cursorPos + insertText.length);
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed');
        });
    }
}
</script>
{% endblock %}

