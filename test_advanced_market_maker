#!/bin/bash

# Test Advanced Market Maker Features
# Tests iceberg orders, TWAP, VWAP, risk management, circuit breakers, and more

echo "========================================="
echo "  TESTING ADVANCED MARKET MAKER FEATURES"
echo "========================================="
echo ""

API_URL="http://localhost:5002/api/v1"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test counter
TESTS_PASSED=0
TESTS_FAILED=0

# Test function
test_endpoint() {
    local name="$1"
    local method="$2"
    local endpoint="$3"
    local data="$4"
    
    echo -n "Testing: $name... "
    
    if [ "$method" = "GET" ]; then
        response=$(curl -s "$API_URL$endpoint")
    else
        response=$(curl -s -X "$method" "$API_URL$endpoint" \
            -H "Content-Type: application/json" \
            -d "$data")
    fi
    
    if echo "$response" | grep -q '"success": true'; then
        echo -e "${GREEN}✅ PASSED${NC}"
        TESTS_PASSED=$((TESTS_PASSED + 1))
        echo "   Response: $(echo $response | jq -r '.message // .status // "OK"')"
    else
        echo -e "${RED}❌ FAILED${NC}"
        TESTS_FAILED=$((TESTS_FAILED + 1))
        echo "   Error: $(echo $response | jq -r '.error // "Unknown error"')"
    fi
    echo ""
}

echo "========================================="
echo "1. ICEBERG ORDERS"
echo "========================================="
echo ""

test_endpoint \
    "Place Iceberg Order (10,000 shares, show 100)" \
    "POST" \
    "/orders/iceberg" \
    '{
        "symbol": "AAPL",
        "side": "buy",
        "total_quantity": 10000,
        "visible_quantity": 100,
        "price": 150.50
    }'

test_endpoint \
    "Place Iceberg Order (Large block)" \
    "POST" \
    "/orders/iceberg" \
    '{
        "symbol": "MSFT",
        "side": "sell",
        "total_quantity": 50000,
        "visible_quantity": 500,
        "price": 380.00
    }'

echo "========================================="
echo "2. TWAP ORDERS"
echo "========================================="
echo ""

test_endpoint \
    "Place TWAP Order (60 minutes)" \
    "POST" \
    "/orders/twap" \
    '{
        "symbol": "AAPL",
        "side": "buy",
        "total_quantity": 10000,
        "duration_minutes": 60
    }'

test_endpoint \
    "Place TWAP Order (30 minutes)" \
    "POST" \
    "/orders/twap" \
    '{
        "symbol": "GOOGL",
        "side": "sell",
        "total_quantity": 5000,
        "duration_minutes": 30
    }'

echo "========================================="
echo "3. VWAP ORDERS"
echo "========================================="
echo ""

test_endpoint \
    "Place VWAP Order (10% participation)" \
    "POST" \
    "/orders/vwap" \
    '{
        "symbol": "AAPL",
        "side": "buy",
        "total_quantity": 10000,
        "target_participation": 0.1
    }'

test_endpoint \
    "Place VWAP Order (20% participation)" \
    "POST" \
    "/orders/vwap" \
    '{
        "symbol": "TSLA",
        "side": "sell",
        "total_quantity": 8000,
        "target_participation": 0.2
    }'

echo "========================================="
echo "4. BLOCK TRADING"
echo "========================================="
echo ""

test_endpoint \
    "Execute Block Trade (100,000 shares)" \
    "POST" \
    "/trades/block" \
    '{
        "symbol": "AAPL",
        "side": "buy",
        "quantity": 100000,
        "price": 150.50,
        "counterparty": "Goldman Sachs"
    }'

test_endpoint \
    "Execute Block Trade (Institutional)" \
    "POST" \
    "/trades/block" \
    '{
        "symbol": "MSFT",
        "side": "sell",
        "quantity": 250000,
        "price": 380.00,
        "counterparty": "JP Morgan"
    }'

echo "========================================="
echo "5. RISK MANAGEMENT"
echo "========================================="
echo ""

test_endpoint \
    "Get Risk Metrics (AAPL)" \
    "GET" \
    "/risk/metrics/AAPL" \
    ""

test_endpoint \
    "Get Risk Dashboard" \
    "GET" \
    "/risk/dashboard" \
    ""

echo "========================================="
echo "6. CIRCUIT BREAKERS"
echo "========================================="
echo ""

test_endpoint \
    "Check Circuit Breaker (5% move - OK)" \
    "POST" \
    "/circuit-breaker/check" \
    '{
        "symbol": "AAPL",
        "current_price": 150.50,
        "previous_price": 143.00
    }'

test_endpoint \
    "Check Circuit Breaker (15% move - HALT)" \
    "POST" \
    "/circuit-breaker/check" \
    '{
        "symbol": "TSLA",
        "current_price": 250.00,
        "previous_price": 217.00
    }'

test_endpoint \
    "Check Circuit Breaker (25% move - HALT)" \
    "POST" \
    "/circuit-breaker/check" \
    '{
        "symbol": "NVDA",
        "current_price": 500.00,
        "previous_price": 400.00
    }'

echo "========================================="
echo "7. MARKET SURVEILLANCE"
echo "========================================="
echo ""

test_endpoint \
    "Detect Wash Trading (AAPL)" \
    "GET" \
    "/surveillance/wash-trading/AAPL" \
    ""

test_endpoint \
    "Detect Unusual Activity (Normal)" \
    "POST" \
    "/surveillance/unusual-activity" \
    '{
        "symbol": "AAPL",
        "current_volume": 1000000,
        "avg_volume": 900000
    }'

test_endpoint \
    "Detect Unusual Activity (5x volume)" \
    "POST" \
    "/surveillance/unusual-activity" \
    '{
        "symbol": "MSFT",
        "current_volume": 5000000,
        "avg_volume": 1000000
    }'

echo "========================================="
echo "8. DYNAMIC SPREADS"
echo "========================================="
echo ""

test_endpoint \
    "Calculate Dynamic Spread (Low volatility)" \
    "POST" \
    "/spreads/calculate" \
    '{
        "symbol": "AAPL",
        "base_spread": 0.005,
        "position_size": 1000,
        "volatility": 0.01
    }'

test_endpoint \
    "Calculate Dynamic Spread (High volatility)" \
    "POST" \
    "/spreads/calculate" \
    '{
        "symbol": "TSLA",
        "base_spread": 0.005,
        "position_size": 5000,
        "volatility": 0.05
    }'

echo "========================================="
echo "9. HEALTH CHECK"
echo "========================================="
echo ""

test_endpoint \
    "Health Check" \
    "GET" \
    "/health" \
    ""

echo "========================================="
echo "  TEST SUMMARY"
echo "========================================="
echo ""
echo -e "${GREEN}Tests Passed: $TESTS_PASSED${NC}"
echo -e "${RED}Tests Failed: $TESTS_FAILED${NC}"
echo ""

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}✅ ALL TESTS PASSED!${NC}"
    echo ""
    echo "Advanced Market Maker Features:"
    echo "  ✅ Iceberg Orders"
    echo "  ✅ TWAP Orders"
    echo "  ✅ VWAP Orders"
    echo "  ✅ Block Trading"
    echo "  ✅ Risk Management"
    echo "  ✅ Circuit Breakers"
    echo "  ✅ Market Surveillance"
    echo "  ✅ Dynamic Spreads"
    echo ""
    exit 0
else
    echo -e "${RED}❌ SOME TESTS FAILED${NC}"
    echo ""
    exit 1
fi
